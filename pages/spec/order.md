---
title: 受注関連
keywords: spec-order
tags: [spec, getting_started]
sidebar: home_sidebar
permalink: spec_order
summary: 受注関連の機能仕様について解説します。
---

## 受注対応状況の流れ

![受注ステートマシーン図](/images/spec/order-statemachine.png)

[参考: 受注ステートマシンの実装 #3325](https://github.com/EC-CUBE/ec-cube/pull/3325)

### 3系との比較

| ID | 3系<br> mtb_order_status<br>(管理画面側表示) | 3系<br> mtb_customer_order_status<br>(フロント側表示) | 4系<br> mtb_order_status<br>(管理画面側表示) | 4系<br>mtb_customer_order_status<br>(フロント側表示) |
|----|----------------------------------------------|-------------------------------------------------------|----------------------------------------------|------------------------------------------------------|
|  1 | 新規受付                                     | 注文受付                                              | 新規受付                                     | 注文受付                                             |
|  2 | 入金待ち                                     | 入金待ち                                              | (欠番)                                       | (欠番)                                               |
|  3 | キャンセル                                   | キャンセル                                            | 注文取り消し                                 | 注文取り消し                                         |
|  4 | 取り寄せ中                                   | 注文受付                                              | 対応中                                       | 注文受付                                             |
|  5 | 発送済み                                     | 発送済み                                              | 発送済み                                     | 発送済み                                             |
|  6 | 入金済み                                     | 注文受付                                              | 入金済み                                     | 注文受付                                             |
|  7 | 決済処理中                                   | 注文未完了                                            | 決済処理中                                   | 注文受付                                             |
|  8 | 購入処理中                                   | 注文未完了                                            | 購入処理中                                   | 注文未完了                                           |
|  9 | (無し)                                       | (無し)                                                | 返品                                         | 返品                                                 |

- データ移行の事も踏まえて、IDは極力変更はしない。
- **4: 取り寄せ中** を **4: 対応中** としてまとめる。
- **2: 入金待ち** を削除。今までのリンク型決済時の入金確認待ち状態である。 **2: 入金待ち** については **7 : 決済処理中** で対応。銀行振込等発送前の入金待ちは **1：新規受付** にて対応するようにする。
- **3: キャンセル** は **3: 注文取消し** に文言を変更。商品発送前の取り消しに使用する。（返品ステータスが追加されたことにより、分かりやすいよう注文取消しに変更。）
- 新たに **9 : 返品** を追加する。

ステータスの流れとしては、

「購入処理中」→「決済処理中」→「新規受付」→「入金済み」または「処理中」→「発送済み」→ 発送後キャンセルがあれば「返品」

が主なステータスの流れとなる。

#### 注文取消し・返品時のステータス処理

##### 注文取消し

発送前にキャンセルがあった場合、注文取消しを選択すると在庫、ポイントの戻しを行う。

「発送済み」が選択されたら「注文取消し」は選択できない。

##### 返品

発送後、商品の返品があった場合、返品を選択する。返品されても在庫やポイントの戻しを行わない。

## 料金計算の仕様

### 受注関連テーブルのER図

![受注関連テーブルのER図](/images/spec/order-erdiagram.png)

### 3系からの主な変更点

- dtb_shipment_item は dtb_order_item に変更されました。
- dtb_order_detail は廃止されました。
- dtb_order **1:N** dtb_order_item **N:1** dtb_shipping という関連に変更されました。
- 商品以外でも、送料・手数料・値引き等の項目を明細として扱えるよう、 dtb_order_item に注文明細の属性が追加されました。


### 計算方法

注文明細の属性に従い、お支払い金額を算出します。
以下の例のように、属性により集計方法が異なりますので注意が必要です。

商品明細は、**税抜価格**で登録されるため集計時に税額分を**加算する**

```
明細合計 = (商品単価 x 税率) x 数量
```

送料明細は、**税込価格**で登録されるため集計時に税額分を**加算しない**

```
明細合計 = 送料単価 x 数量
```

[参考: #3420 明細種別ごとの計算結果](https://github.com/EC-CUBE/ec-cube/pull/3420)

### 注文明細の属性

#### 注文明細区分

| ID | name           | 備考                                           |
|----|----------------|------------------------------------------------|
|  1 | 商品           |                                                |
|  2 | 送料           |                                                |
|  3 | 手数料         |                                                |
|  4 | 値引き         | 主に商品の値引きに使用する。課税値引き。       |
|  5 | 税             | 注文全体に対して課税する場合などに使用する。   |
|  6 | ポイント値引き | 利用ポイントの値引きに使用する。不課税値引き。 |

#### 課税区分

| ID | name   | 備考           |
|----|--------|----------------|
|  1 | 課税   |                |
|  2 | 不課税 | ポイント値引等 |
|  3 | 非課税 | 商品券の譲渡等 |

#### 税表示区分

| ID | name | 備考                               |
|----|------|------------------------------------|
|  1 | 税抜 | 商品明細等、税抜価格で登録するもの |
|  2 | 税込 | 送料等、税込価格で登録するもの     |

### ポイントの計算

#### ポイント利用時の計算

```
ポイント値引き額 = 利用ポイント * ポイント換算レート
```

端数は切り捨てられます。課税区分は不課税です。


#### ポイント加算時の計算

商品明細に対して加算ポイントが計算されます。

```
加算ポイント = 商品単価(税抜) * ポイント付与率 * 数量
```

利用ポイントがある場合は、ポイント値引き額分が控除されます。

```
控除ポイント = ポイント値引き額 * ポイント付与率 * 数量
```

加算ポイントと、控除ポイントの合計が、該当の注文で加算される最終的なポイント合計となります。

### 送料無料条件の計算

送料無料条件を設定した場合、お届け先ごとに商品合計金額(税込)の集計を行ない、送料無料条件の判定をします。

例) 送料無料条件:3,000円の場合

| お届け先  | 商品合計金額 | 送料無料判定 |
|-----------|--------------|--------------|
| お届け先A | 2,900        | ×           |
| お届け先B | 3,200        | ○           |


### 消費税の設定

### 商品別税率設定について

商品別税率設定は、以下の設定が可能です。

- 商品登録画面で税率を設定できる(規格なし商品)
- 商品規格登録画面で、税率を設定できる(規格あり商品)
- 空を登録した場合はdtb_tax_ruleの税率を削除する

以下の制限事項があります。

- 共通税率のように、履歴は保持されません。
- 商品登録・編集時は個別税率は常に更新されます。
- 受注編集時は、
   - 個別税率が適用された商品明細は、常に最新の値で更新されます。
   - 商品に登録されている税率が削除された場合、基本税率が適用されます。

### 販売種別について

販売種別を設定することにより、販売種別ごとに決済手段を分けることが可能です。

異なる販売種別の商品を同時にカートへ投入すると、販売種別ごとにカートが分割されます。
カートごとに、ご注文手続きを進めることができます。

